@model ChatViewModel

@{
	ViewData["Title"] = "Chat";
	Layout = "~/Views/Shared/_Layout.cshtml";
	ViewBag.ParentPageName = "<a href='#'><i class='ri-home-2-line'></i> Home</a>";
	ViewBag.PageName = "<i class='ri-chat-3-line'></i>  Chat";
}

<style>
	@@media(min-width: 992px) {
		.chat-leftsidebar {
			min-width: 300px;
			max-width: 300px;
			height: calc(100vh - 70px - 60px - -4px) !important;
		}
	}

	#users-conversation {
		display: flex;
		flex-direction: column;
	}

	.chat-user-img.online .user-status {
		background-color: #67b173;
	}

</style>
<<div class="chat-wrapper d-lg-flex gap-1 mx-n4 mt-n4 p-1">
	<div class="chat-leftsidebar">
		<div class="px-4 pt-4 mb-4">
			<div class="d-flex align-items-start">
				<div class="flex-grow-1">
					<h5 class="mb-4">Chats</h5>
				</div>
				<div class="flex-shrink-0">
					<div data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="bottom" title="Add Contact">

						<!-- Button trigger modal -->
						<button type="button" class="btn btn-soft-success btn-sm">
							<i class="ri-add-line align-bottom"></i>
						</button>
					</div>
				</div>
			</div>
			<div class="search-box">
				<input type="text" class="form-control bg-light border-light" placeholder="Search here...">
				<i class="ri-search-2-line search-icon"></i>
			</div>

		</div> <!-- .p-4 -->

		<ul class="nav nav-tabs nav-tabs-custom nav-success nav-justified" role="tablist">
			<li class="nav-item">
				<a class="nav-link active" data-bs-toggle="tab" href="#chats" role="tab">
					Chats
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" data-bs-toggle="tab" href="#contacts" role="tab">
					Contacts
				</a>
			</li>
		</ul>

		<div class="tab-content text-muted">
			<div class="tab-pane active" id="chats" role="tabpanel">
				<div class="chat-room-list pt-3" data-simplebar>
					<div class="d-flex align-items-center px-4 mb-2">
						<div class="flex-grow-1">
							<h4 class="mb-0 fs-12 text-muted text-uppercase">Direct Messages</h4>
						</div>
						<div class="flex-shrink-0">
							<div data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="bottom" title="New Message">

								<!-- Button trigger modal -->
								<button type="button" class="btn btn-soft-success btn-sm shadow-none">
									<i class="ri-add-line align-bottom"></i>
								</button>
							</div>
						</div>
					</div>

					<div class="chat-message-list">

						<ul class="list-unstyled chat-list chat-user-list" id="userList">
						</ul>
					</div>

					<div class="d-flex align-items-center px-4 mt-4 pt-2 mb-2">
						<div class="flex-grow-1">
							<h4 class="mb-0 fs-11 text-muted text-uppercase">Channels</h4>
						</div>
						<div class="flex-shrink-0">
							<div data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="bottom" title="Create group">
								<!-- Button trigger modal -->
								<button type="button" class="btn btn-soft-success btn-sm">
									<i class="ri-add-line align-bottom"></i>
								</button>
							</div>
						</div>
					</div>

					@* <div class="chat-message-list">

						<ul class="list-unstyled chat-list chat-user-list mb-0" id="channelList">
						</ul>
					</div> *@
					<!-- End chat-message-list -->
				</div>
			</div>
			<div class="tab-pane" id="contacts" role="tabpanel">
				<div class="chat-room-list pt-3" data-simplebar>
					<div class="sort-contact">
						<ul class="list-unstyled contact-list" id="contactList"></ul>
					</div>
				</div>
			</div>
		</div>
		<!-- end tab contact -->
	</div>
	<!-- end chat leftsidebar -->
	<!-- Start User chat -->
	<div class="user-chat w-100 overflow-hidden">

		<div class="chat-content d-lg-flex">
			<!-- start chat conversation section -->
			<div class="w-100 overflow-hidden position-relative">
				<!-- conversation user -->
				<div class="position-relative">


					<div class="position-relative" id="users-chat">
						<div class="p-3 user-chat-topbar">
							<div class="row align-items-center">
								<div class="col-sm-4 col-8">
									<div class="d-flex align-items-center">
										<div class="flex-shrink-0 d-block d-lg-none me-3">
											<a href="javascript: void(0);" class="user-chat-remove fs-18 p-1"><i class="ri-arrow-left-s-line align-bottom"></i></a>
										</div>
										<div class="flex-grow-1 overflow-hidden">
											<div class="d-flex align-items-center">
												<div class="flex-shrink-0 chat-user-img online user-own-img align-self-center me-3 ms-0">
													<img src="~/assets/images/users/avatar-2.jpg" class="rounded-circle avatar-xs" alt="">
													<span class="user-status"></span>
												</div>
												<div class="flex-grow-1 overflow-hidden">
													<h5 class="text-truncate mb-0 fs-16"><a class="text-reset username" data-bs-toggle="offcanvas" href="#userProfileCanvasExample" aria-controls="userProfileCanvasExample"></a></h5>

												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="col-sm-8 col-4">
									<ul class="list-inline user-chat-nav text-end mb-0">
										<li class="list-inline-item m-0">
											<div class="dropdown">
												<button class="btn btn-ghost-secondary btn-icon" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
													<i data-feather="search" class="icon-sm"></i>
												</button>
												<div class="dropdown-menu p-0 dropdown-menu-end dropdown-menu-lg">
													<div class="p-2">
														<div class="search-box">
															<input type="text" class="form-control bg-light border-light" placeholder="Search here..." onkeyup="searchMessages()" id="searchMessage">
															<i class="ri-search-2-line search-icon"></i>
														</div>
													</div>
												</div>
											</div>
										</li>

										<li class="list-inline-item d-none d-lg-inline-block m-0">
											<button type="button" class="btn btn-ghost-secondary btn-icon" data-bs-toggle="offcanvas" data-bs-target="#userProfileCanvasExample" aria-controls="userProfileCanvasExample">
												<i data-feather="info" class="icon-sm"></i>
											</button>
										</li>

										<li class="list-inline-item m-0">
											<div class="dropdown">
												<button class="btn btn-ghost-secondary btn-icon" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
													<i data-feather="more-vertical" class="icon-sm"></i>
												</button>
												<div class="dropdown-menu dropdown-menu-end">
													<a class="dropdown-item d-block d-lg-none user-profile-show" href="#"><i class="ri-user-2-fill align-bottom text-muted me-2"></i> View Profile</a>
													<a class="dropdown-item" href="#"><i class="ri-inbox-archive-line align-bottom text-muted me-2"></i> Archive</a>
													<a class="dropdown-item" href="#"><i class="ri-mic-off-line align-bottom text-muted me-2"></i> Muted</a>
													<a class="dropdown-item" href="#"><i class="ri-delete-bin-5-line align-bottom text-muted me-2"></i> Delete</a>
												</div>
											</div>
										</li>
									</ul>
								</div>
							</div>

						</div>
						<!-- end chat user head -->
						<div class="chat-conversation p-3 p-lg-4 " id="chat-conversation" data-simplebar>
							<div id="elmLoader">
								<div class="spinner-border text-primary avatar-sm" role="status">
									<span class="visually-hidden">Loading...</span>
								</div>
							</div>
							<ul class="list-unstyled chat-conversation-list" id="users-conversation">
							</ul>
							<!-- end chat-conversation-list -->
						</div>
						<div class="alert alert-warning alert-dismissible copyclipboard-alert px-4 fade show " id="copyClipBoard" role="alert">
							Message copied
						</div>
					</div>

					<div class="position-relative" id="channel-chat">
						<div class="p-3 user-chat-topbar">
							<div class="row align-items-center">
								<div class="col-sm-4 col-8">
									<div class="d-flex align-items-center">
										<div class="flex-shrink-0 d-block d-lg-none me-3">
											<a href="javascript: void(0);" class="user-chat-remove fs-18 p-1"><i class="ri-arrow-left-s-line align-bottom"></i></a>
										</div>
										<div class="flex-grow-1 overflow-hidden">
											<div class="d-flex align-items-center">
												<div class="flex-shrink-0 chat-user-img online user-own-img align-self-center me-3 ms-0">
													<img src="~/assets/images/users/avatar-2.jpg" class="rounded-circle avatar-xs" alt="">
												</div>
												<div class="flex-grow-1 overflow-hidden">
													<h5 class="text-truncate mb-0 fs-16"><a class="text-reset username" data-bs-toggle="offcanvas" href="#userProfileCanvasExample" aria-controls="userProfileCanvasExample">Lisa Parker</a></h5>
													<p class="text-truncate text-muted fs-14 mb-0 userStatus"><small>24 Members</small></p>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="col-sm-8 col-4">
									<ul class="list-inline user-chat-nav text-end mb-0">
										<li class="list-inline-item m-0">
											<div class="dropdown">
												<button class="btn btn-ghost-secondary btn-icon" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
													<i data-feather="search" class="icon-sm"></i>
												</button>
												<div class="dropdown-menu p-0 dropdown-menu-end dropdown-menu-lg">
													<div class="p-2">
														<div class="search-box">
															<input type="text" class="form-control bg-light border-light" placeholder="Search here..." onkeyup="searchMessages()" id="searchMessage">
															<i class="ri-search-2-line search-icon"></i>
														</div>
													</div>
												</div>
											</div>
										</li>

										<li class="list-inline-item d-none d-lg-inline-block m-0">
											<button type="button" class="btn btn-ghost-secondary btn-icon" data-bs-toggle="offcanvas" data-bs-target="#userProfileCanvasExample" aria-controls="userProfileCanvasExample">
												<i data-feather="info" class="icon-sm"></i>
											</button>
										</li>

										<li class="list-inline-item m-0">
											<div class="dropdown">
												<button class="btn btn-ghost-secondary btn-icon" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
													<i data-feather="more-vertical" class="icon-sm"></i>
												</button>
												<div class="dropdown-menu dropdown-menu-end">
													<a class="dropdown-item d-block d-lg-none user-profile-show" href="#"><i class="ri-user-2-fill align-bottom text-muted me-2"></i> View Profile</a>
													<a class="dropdown-item" href="#"><i class="ri-inbox-archive-line align-bottom text-muted me-2"></i> Archive</a>
													<a class="dropdown-item" href="#"><i class="ri-mic-off-line align-bottom text-muted me-2"></i> Muted</a>
													<a class="dropdown-item" href="#"><i class="ri-delete-bin-5-line align-bottom text-muted me-2"></i> Delete</a>
												</div>
											</div>
										</li>
									</ul>
								</div>
							</div>

						</div>
						<!-- end chat user head -->
						<div class="chat-conversation p-3 p-lg-4" id="chat-conversation" data-simplebar>
							<ul class="list-unstyled chat-conversation-list" id="channel-conversation">
							</ul>
							<!-- end chat-conversation-list -->

						</div>
						<div class="alert alert-warning alert-dismissible copyclipboard-alert px-4 fade show " id="copyClipBoardChannel" role="alert">
							Message copied
						</div>
					</div>

					<!-- end chat-conversation -->

					<div class="chat-input-section p-3 p-lg-4">

						<form id="chatinput-form" enctype="multipart/form-data">
							<div class="row g-0 align-items-center">
								<div class="col-auto">
									<div class="chat-input-links me-2">
										<div class="links-list-item">
											<button type="button" class="btn btn-link text-decoration-none emoji-btn" id="emoji-btn">
												<i class="bx bx-smile align-middle"></i>
											</button>
										</div>
									</div>
								</div>

								<div class="col">
									<div class="chat-input-feedback">
										Please Enter a Message
									</div>
									<input type="text" id="chatInput" class="form-control chat-input bg-light border-light" placeholder="Type your message..." autocomplete="off">
								</div>
								<div class="col-auto">
									<div class="chat-input-links ms-2">
										<div class="links-list-item">
											<button type="button" id="sendMessageBtn" class="btn btn-success chat-send waves-effect waves-light">
												<i class="ri-send-plane-2-fill align-bottom"></i>
											</button>
										</div>
									</div>
								</div>

							</div>=
						</form>
					</div>

					<div class="replyCard">
						<div class="card mb-0">
							<div class="card-body py-3">
								<div class="replymessage-block mb-0 d-flex align-items-start">
									<div class="flex-grow-1">
										<h5 class="conversation-name"></h5>
										<p class="mb-0"></p>
									</div>
									<div class="flex-shrink-0">
										<button type="button" id="close_toggle" class="btn btn-sm btn-link mt-n2 me-n3 fs-18">
											<i class="bx bx-x align-middle"></i>
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- end chat-wrapper -->


<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="userProfileCanvasExample">
	<!--end offcanvas-header-->
	<div class="offcanvas-body profile-offcanvas p-0">
		<div class="team-cover">
			<img src="~/assets/images/small/img-9.jpg" alt="" class="img-fluid" />
		</div>
		<div class="p-1 pb-4 pt-0">
			<div class="team-settings">
				<div class="row g-0">
					<div class="col">
						<div class="btn nav-btn">
							<button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
						</div>
					</div>
					<div class="col-auto">
						<div class="user-chat-nav d-flex">
							<button type="button" class="btn nav-btn favourite-btn active">
								<i class="ri-star-fill"></i>
							</button>

							<div class="dropdown">
								<a class="btn nav-btn" href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false">
									<i class="ri-more-2-fill"></i>
								</a>
								<ul class="dropdown-menu dropdown-menu-end">
									<li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-inbox-archive-line align-bottom text-muted me-2"></i>Archive</a></li>
									<li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-mic-off-line align-bottom text-muted me-2"></i>Muted</a></li>
									<li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-delete-bin-5-line align-bottom text-muted me-2"></i>Delete</a></li>
								</ul>
							</div>
						</div>

					</div>
				</div>
			</div>
			<!--end col-->
		</div>
		<div class="p-3 text-center">
			<img src="~/assets/images/users/avatar-2.jpg" alt="" class="avatar-lg img-thumbnail rounded-circle mx-auto profile-img">
			<div class="mt-3">
				<h5 class="fs-16 mb-1"><a href="javascript:void(0);" class="link-primary username">Lisa Parker</a></h5>
				<p class="text-muted"><i class="ri-checkbox-blank-circle-fill me-1 align-bottom text-success"></i>Online</p>
			</div>

			<div class="d-flex gap-3 justify-content-center">
				<button type="button" class="btn avatar-xs p-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Message">
					<span class="avatar-title rounded bg-light text-body">
						<i class="ri-question-answer-line"></i>
					</span>
				</button>

				<button type="button" class="btn avatar-xs p-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Favourite">
					<span class="avatar-title rounded bg-light text-body">
						<i class="ri-star-line"></i>
					</span>
				</button>

				<button type="button" class="btn avatar-xs p-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Phone">
					<span class="avatar-title rounded bg-light text-body">
						<i class="ri-phone-line"></i>
					</span>
				</button>

				<div class="dropdown">
					<button class="btn avatar-xs p-0" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						<span class="avatar-title bg-light text-body rounded">
							<i class="ri-more-fill"></i>
						</span>
					</button>

					<ul class="dropdown-menu dropdown-menu-end">
						<li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-inbox-archive-line align-bottom text-muted me-2"></i>Archive</a></li>
						<li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-mic-off-line align-bottom text-muted me-2"></i>Muted</a></li>
						<li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-delete-bin-5-line align-bottom text-muted me-2"></i>Delete</a></li>
					</ul>
				</div>
			</div>
		</div>

		<div class="border-top border-top-dashed p-3">
			<h5 class="fs-16 mb-3">Personal Details</h5>
			<div class="mb-3">
				<p class="text-muted text-uppercase fw-semibold fs-13 mb-1">Number</p>
				<h6>+(256) 2451 8974</h6>
			</div>
			<div class="mb-3">
				<p class="text-muted text-uppercase fw-semibold fs-13 mb-1">Email</p>
				<h6>lisaparker@gmail.com</h6>
			</div>
			<div>
				<p class="text-muted text-uppercase fw-semibold fs-13 mb-1">Location</p>
				<h6 class="mb-0">California, USA</h6>
			</div>
		</div>

		<div class="border-top border-top-dashed p-3">
			<h5 class="fs-16 mb-3">Attached Files</h5>

			<div class="vstack gap-2">
				<div class="border rounded border-dashed p-2">
					<div class="d-flex align-items-center">
						<div class="flex-shrink-0 me-3">
							<div class="avatar-xs">
								<div class="avatar-title bg-light text-secondary rounded fs-20">
									<i class="ri-folder-zip-line"></i>
								</div>
							</div>
						</div>
						<div class="flex-grow-1 overflow-hidden">
							<h5 class="fs-15 mb-1"><a href="#" class="text-body text-truncate d-block">App pages.zip</a></h5>
							<div class="text-muted">2.2MB</div>
						</div>
						<div class="flex-shrink-0 ms-2">
							<div class="d-flex gap-1">
								<button type="button" class="btn btn-icon text-muted btn-sm fs-18"><i class="ri-download-2-line"></i></button>
								<div class="dropdown">
									<button class="btn btn-icon text-muted btn-sm fs-18 dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
										<i class="ri-more-fill"></i>
									</button>
									<ul class="dropdown-menu">
										<li><a class="dropdown-item" href="#"><i class="ri-share-line align-bottom me-2 text-muted"></i> Share</a></li>
										<li><a class="dropdown-item" href="#"><i class="ri-bookmark-line align-bottom me-2 text-muted"></i> Bookmark</a></li>
										<li><a class="dropdown-item" href="#"><i class="ri-delete-bin-line align-bottom me-2 text-muted"></i> Delete</a></li>
									</ul>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="border rounded border-dashed p-2">
					<div class="d-flex align-items-center">
						<div class="flex-shrink-0 me-3">
							<div class="avatar-xs">
								<div class="avatar-title bg-light text-secondary rounded fs-20">
									<i class="ri-file-ppt-2-line"></i>
								</div>
							</div>
						</div>
						<div class="flex-grow-1 overflow-hidden">
							<h5 class="fs-15 mb-1"><a href="#" class="text-body text-truncate d-block">Velzon admin.ppt</a></h5>
							<div class="text-muted">2.4MB</div>
						</div>
						<div class="flex-shrink-0 ms-2">
							<div class="d-flex gap-1">
								<button type="button" class="btn btn-icon text-muted btn-sm fs-18"><i class="ri-download-2-line"></i></button>
								<div class="dropdown">
									<button class="btn btn-icon text-muted btn-sm fs-18 dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
										<i class="ri-more-fill"></i>
									</button>
									<ul class="dropdown-menu">
										<li><a class="dropdown-item" href="#"><i class="ri-share-line align-bottom me-2 text-muted"></i> Share</a></li>
										<li><a class="dropdown-item" href="#"><i class="ri-bookmark-line align-bottom me-2 text-muted"></i> Bookmark</a></li>
										<li><a class="dropdown-item" href="#"><i class="ri-delete-bin-line align-bottom me-2 text-muted"></i> Delete</a></li>
									</ul>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="border rounded border-dashed p-2">
					<div class="d-flex align-items-center">
						<div class="flex-shrink-0 me-3">
							<div class="avatar-xs">
								<div class="avatar-title bg-light text-secondary rounded fs-20">
									<i class="ri-folder-zip-line"></i>
								</div>
							</div>
						</div>
						<div class="flex-grow-1 overflow-hidden">
							<h5 class="fs-15 mb-1"><a href="#" class="text-body text-truncate d-block">Images.zip</a></h5>
							<div class="text-muted">1.2MB</div>
						</div>
						<div class="flex-shrink-0 ms-2">
							<div class="d-flex gap-1">
								<button type="button" class="btn btn-icon text-muted btn-sm fs-18"><i class="ri-download-2-line"></i></button>
								<div class="dropdown">
									<button class="btn btn-icon text-muted btn-sm fs-18 dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
										<i class="ri-more-fill"></i>
									</button>
									<ul class="dropdown-menu">
										<li><a class="dropdown-item" href="#"><i class="ri-share-line align-bottom me-2 text-muted"></i> Share</a></li>
										<li><a class="dropdown-item" href="#"><i class="ri-bookmark-line align-bottom me-2 text-muted"></i> Bookmark</a></li>
										<li><a class="dropdown-item" href="#"><i class="ri-delete-bin-line align-bottom me-2 text-muted"></i> Delete</a></li>
									</ul>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="border rounded border-dashed p-2">
					<div class="d-flex align-items-center">
						<div class="flex-shrink-0 me-3">
							<div class="avatar-xs">
								<div class="avatar-title bg-light text-secondary rounded fs-20">
									<i class="ri-image-2-line"></i>
								</div>
							</div>
						</div>
						<div class="flex-grow-1 overflow-hidden">
							<h5 class="fs-15 mb-1"><a href="#" class="text-body text-truncate d-block">bg-pattern.png</a></h5>
							<div class="text-muted">1.1MB</div>
						</div>
						<div class="flex-shrink-0 ms-2">
							<div class="d-flex gap-1">
								<button type="button" class="btn btn-icon text-muted btn-sm fs-18"><i class="ri-download-2-line"></i></button>
								<div class="dropdown">
									<button class="btn btn-icon text-muted btn-sm fs-18 dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
										<i class="ri-more-fill"></i>
									</button>
									<ul class="dropdown-menu">
										<li><a class="dropdown-item" href="#"><i class="ri-share-line align-bottom me-2 text-muted"></i> Share</a></li>
										<li><a class="dropdown-item" href="#"><i class="ri-bookmark-line align-bottom me-2 text-muted"></i> Bookmark</a></li>
										<li><a class="dropdown-item" href="#"><i class="ri-delete-bin-line align-bottom me-2 text-muted"></i> Delete</a></li>
									</ul>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="text-center mt-2">
					<button type="button" class="btn btn-danger">Load more <i class="ri-arrow-right-fill align-bottom ms-1"></i></button>
				</div>
			</div>
		</div>
	</div>
	<!--end offcanvas-body-->
</div>




@section Scripts {
	<script src="~/assets/libs/glightbox/js/glightbox.min.js"></script>

	<!-- fgEmojiPicker js -->
	<script src="~/assets/libs/fg-emoji-picker/fgEmojiPicker.js"></script>

	<!-- chat init js -->
	<script src="~/assets/js/pages/chat.init.js"></script>
	<script>

		let selectedUserId = null;
		let connection = null;
		let currentUserId = @Model.CurrentUserId;

		// ---------------------------
		// START SIGNALR
		// ---------------------------
		function startConnection() {

			connection = new signalR.HubConnectionBuilder()
				.withUrl("/chathub")
				.withAutomaticReconnect()
				.build();

			// Receive message
			connection.on("ReceiveMessage", function (msg) {

					   // If the incoming message is from the user currently opened in chat, append it
		if (selectedUserId && selectedUserId === msg.fromUserId) {
			appendMessageToChat(msg);
			setTimeout(scrollBottom, 50);

				 $.get("/Chat/MarkMessagesRead", { targetUserId: msg.fromUserId });

		// Remove unread badge (if existed)
		removeUnreadBadge(msg.fromUserId);
		}
		else {
			// Chat with this sender is NOT open. Do NOT open it automatically.
			// Instead update sidebar preview/unread UI without reloading the whole list.
			// Minimal helpers below will update unread count and last message preview.
			increaseUnreadCount(msg.fromUserId);
		}

		// Update last message preview for that user (without refreshing entire list)
		updateLastMessageInSidebar(msg);
			});

			connection.start()
				.then(() => console.log("SignalR Connected"))
				.catch(err => console.error(err));
		}

				// Increase unread count badge (create if not present)
		function increaseUnreadCount(userId) {
			// find the user list item by the data you render; we used .chat-user-item earlier
			const row = $(`#userList .chat-user-item`).filter(function () {
				// this assumes your <li> was created with onclick="openChat(userId, 'name', isOnline)"
				// we don't have data-userid attribute in your markup, so match by the onclick string:
				return $(this).attr("onclick") && $(this).attr("onclick").indexOf(`openChat(${userId},`) !== -1;
			});

			if (!row || row.length === 0) return;

			// try to find existing badge inside the row, otherwise append to the right place
			let badge = row.find(".unread-badge");
			if (badge.length === 0) {
				// append badge similar to your theme markup
				row.find("a").append(`<div class="ms-auto"><span class="badge bg-dark-subtle text-body rounded p-1 unread-badge">1</span></div>`);
			} else {
				let count = parseInt(badge.text() || "0");
				badge.text(count + 1);
			}
		}

		// Update last message preview text in sidebar (without reloading whole list)
		function updateLastMessageInSidebar(msg) {
			const row = $(`#userList .chat-user-item`).filter(function () {
				return $(this).attr("onclick") && $(this).attr("onclick").indexOf(`openChat(${msg.fromUserId},`) !== -1;
			});

			if (!row || row.length === 0) return;

			// update the small text you already render
			row.find("p.small.text-muted").text(msg.message ?? "");
			// update time if you have element for that (you render time inside <small class="text-muted">)
			row.find("small.text-muted").first().text(new Date(msg.sentAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }));
		}


		// ---------------------------
		// LOAD USERS LIST (sidebar)
		// ---------------------------
		function loadUserList() {

			$.get("/Chat/GetChatUsers", function (users) {

				let html = "";

				users.forEach((u, index) => {
					html += `
							<li class="chat-user-item" onclick="openChat(${u.userId}, '${u.userName}', ${u.isOnline})"		>
						<a class="d-flex align-items-center" href="javascript:void(0)">

							 <!-- Theme Avatar + Status -->
					<div class="chat-user-img me-2 ${u.isOnline ? "online" : ""}">
							<img src="/assets/images/users/avatar-1.jpg"
								 class="rounded-circle avatar-xs" />
							<span class="user-status"></span>
						</div>

						<div class="flex-grow-1">
							<h6 class="mb-0">${u.userName}</h6>

						</div>



						<div class="ms-auto">
							${u.unreadCount > 0
								? `<span class="badge bg-dark-subtle text-body rounded p-1 unread-badge">${u.unreadCount}</span>`
								: ``
							}
						</div>

						</a>
					</li>`;
					 if (index === 0) {
				selectedUserId = u.userId;
				$(".username").text(u.userName);
				if (u.isOnline) {
			$(".user-own-img").addClass("online");
		} else {
			$(".user-own-img").removeClass("online");
		}
			}
				});

				$("#userList").html(html);
				  // If there is at least one user, load their messages
		if (users.length > 0) {
			loadMessages();
		}
			});
		}


		// ---------------------------
		// OPEN CHAT
		// ---------------------------
		function openChat(userId, name,isOnline) {

			selectedUserId = userId;

			$(".username").text(name);
		loadMessages();

		removeUnreadBadge(userId);


		// Update header user-profile green dot
		if (isOnline) {
			$(".user-own-img").addClass("online");
		} else {
			$(".user-own-img").removeClass("online");
		}
		}


		// ---------------------------
		// LOAD MESSAGES
		// ---------------------------
		function loadMessages() {
			if (!selectedUserId) return;

			$.get(`/Chat/GetMessages?targetUserId=${selectedUserId}`, function (msgs) {

				$("#users-conversation").html("");

				msgs.forEach(m => appendMessageToChat(m));

				setTimeout(scrollBottom, 100);
				removeUnreadBadge(selectedUserId);
			});
		}
				function removeUnreadBadge(userId) {
			const row = $(`#userList .chat-user-item`).filter(function () {
				return $(this).attr("onclick")?.includes(`openChat(${userId},`);
			});

			row.find(".unread-badge").remove();

		}

		// ---------------------------
		// APPEND MESSAGE TO UI
		// ---------------------------
		function appendMessageToChat(msg) {

			let time = new Date(msg.sentAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });


			let html = "";

			if (msg.isOwnMessage) {
				html = `
				<li class="right">
					<div class="conversation-list">
						<div class="user-chat-content">
							<div class="ctext-wrap">
								<div class="ctext-wrap-content">${msg.message}</div>
							</div>
							<div><small class="text-muted">${time}</small></div>
						</div>
					</div>
				</li>`;
			} else {
				html = `
				<li>
					<div class="conversation-list">
						<div class="chat-avatar">
							<img src="/assets/images/users/avatar-1.jpg" class="rounded-circle avatar-xs" />
						</div>
						<div class="user-chat-content">
							<div class="ctext-wrap">
								<div class="ctext-wrap-content">${msg.message}</div>
							</div>
							<div><small class="text-muted">${time}</small></div>
						</div>
					</div>
				</li>`;
			}

			$("#users-conversation").append(html);
		}


		// ---------------------------
		// AUTO SCROLL
		// ---------------------------
		function scrollBottom() {
			let div = document.getElementById("chat-conversation");
			div.scrollTop = div.scrollHeight;
		}


		// ---------------------------
		// SEND MESSAGE
		// ---------------------------
		$("#sendMessageBtn").click(function () {

			let text = $("#chatInput").val().trim();
			if (!text || !selectedUserId) return;


				 // Show instantly
		appendMessageToChat({
			fromUserId: currentUserId,
			toUserId: selectedUserId,
			message: text,
			sentAt: new Date(),
			isOwnMessage: true
		});

		scrollBottom();

			connection.invoke("SendMessage", selectedUserId, text);


			$("#chatInput").val("");
		});

				// Send message on Enter key
		$("#chatInput").on("keypress", function (e) {
			if (e.which === 13) {   // 13 = Enter key
				e.preventDefault(); // prevent new line
				$("#sendMessageBtn").click(); // Trigger send
			}
		});


							function scrollBottom() {
			const wrapper = document.querySelector("#chat-conversation .simplebar-content-wrapper");
			if (wrapper) {
				wrapper.scrollTop = wrapper.scrollHeight;
			}
		}
						function loadContacts() {
			$.get("/chat/getcontacts", function (contacts) {

				let html = "";
				const grouped = {};
				debugger;
				contacts.forEach(c => {
					const letter = c.name[0].toUpperCase();
					if (!grouped[letter]) grouped[letter] = [];
					grouped[letter].push(c);
				});

				Object.keys(grouped).sort().forEach(letter => {
					html += `
						<li class="mt-3 mb-1">
							<div class="text-muted text-uppercase fs-12">${letter}</div>
						</li>
					`;

					grouped[letter].forEach(c => {
						const initials = c.name
							.split(" ").map(x => x[0]).join("").substring(0, 2).toUpperCase();

						const img =
							`<img src="assets/images/users/avatar-3.jpg" class="avatar-xs rounded-circle">` ;

						html += `
							<li>
								<div class="d-flex align-items-center">
									<div class="flex-shrink-0 me-2">${img}</div>
									<div class="flex-grow-1">
										<p class="text-truncate mb-0 fs-14">${c.name}</p>
									</div>
								</div>
							</li>`;
					});
				});

				$("#contactList").html(html);
			});
		}

		// Load on tab click
		$('a[data-bs-toggle="tab"]').on("shown.bs.tab", function (e) {
			if ($(e.target).attr("href") === "#contacts") {
				loadContacts();
			}
		});






		// ---------------------------
		// ON PAGE LOAD
		// ---------------------------
		$(document).ready(function () {

			loadUserList();
			startConnection();

		});
					window.addEventListener("beforeunload", function () {
			if (connection && connection.connectionId) {
				navigator.sendBeacon(
					"/chat/remove-connection",
					connection.connectionId
				);
			}
		});

	</script>

}

